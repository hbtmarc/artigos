---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { withBase } from '../../lib/withBase';

const homeHref = withBase('');
const postId = Astro.params.id ?? '';

export async function getStaticPaths() {
  const projectId = import.meta.env.PUBLIC_FIREBASE_PROJECT_ID;
  const apiKey = import.meta.env.PUBLIC_FIREBASE_API_KEY;

  if (!projectId || !apiKey) {
    console.warn('Missing Firebase env vars; no static post paths generated.');
    return [];
  }

  const url = `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents/posts?pageSize=500&key=${apiKey}`;

  try {
    const response = await fetch(url);
    if (!response.ok) {
      console.warn('Firestore list failed:', response.status);
      return [];
    }
    const data = await response.json();
    const documents = Array.isArray(data.documents) ? data.documents : [];

    const paths: Array<{ params: { id: string } }> = [];

    documents.forEach((doc) => {
      const name = typeof doc.name === 'string' ? doc.name : '';
      const id = name.split('/').pop() ?? '';
      const status = doc.fields?.status?.stringValue;
      if (id && status === 'published') {
        paths.push({ params: { id } });
      }
    });

    return paths;
  } catch (error) {
    console.warn('Failed to load Firestore posts:', error);
    return [];
  }
}
---
<BaseLayout title="Post | Artigos" description="Leitura do post publicado.">
  <article class="post-content" data-post-id={postId}>
    <header class="post-header">
      <div class="post-meta-row">
        <span class="post-type" data-post-type>Carregando</span>
        <span class="post-date" data-post-date>...</span>
      </div>
      <h1 data-post-title>Carregando...</h1>
      <p class="post-meta" data-post-meta>Carregando autor...</p>
    </header>
    <div class="post-body">
      <pre class="post-content-raw" data-post-content>Carregando...</pre>
    </div>
    <p class="post-back">
      <a href={homeHref}>Voltar para a home</a>
    </p>
  </article>
  <script src="../../scripts/public-post.ts"></script>
</BaseLayout>

---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { withBase } from '../../lib/withBase';
import { db } from '../../lib/firebase/server';
import {
  collection,
  doc,
  getDoc,
  getDocs,
  query,
  where
} from 'firebase/firestore';
import type { Timestamp } from 'firebase/firestore';

const homeHref = withBase('');
const postId = Astro.params.id ?? '';

const typeLabels: Record<string, string> = {
  artigo: 'Artigo',
  roteiro: 'Roteiro',
  'plano-diretor': 'Plano Diretor'
};

const formatDate = (timestamp?: Timestamp | null) => {
  if (!timestamp || typeof timestamp.toDate !== 'function') return 'Sem data';
  return new Intl.DateTimeFormat('pt-BR', { dateStyle: 'medium' }).format(timestamp.toDate());
};

export async function getStaticPaths() {
  const postsQuery = query(collection(db, 'posts'), where('status', '==', 'published'));
  const snapshot = await getDocs(postsQuery);

  return snapshot.docs.map((post) => ({
    params: { id: post.id }
  }));
}

let post:
  | {
      id: string;
      title: string;
      type: string;
      tags?: string[];
      status?: string;
      content?: string;
      publishedAt?: Timestamp | null;
      updatedAt?: Timestamp | null;
    }
  | null = null;

if (!postId) {
  Astro.response.status = 404;
} else {
  try {
    const snapshot = await getDoc(doc(db, 'posts', postId));
    if (!snapshot.exists()) {
      Astro.response.status = 404;
    } else {
      const data = snapshot.data() as Omit<typeof post, 'id'> & { status?: string };
      if (data.status !== 'published') {
        Astro.response.status = 404;
      } else {
        post = { id: snapshot.id, ...data } as NonNullable<typeof post>;
      }
    }
  } catch (error) {
    Astro.response.status = 404;
  }
}
---
<BaseLayout title={post ? `${post.title} | Artigos` : 'Post nao encontrado'} description="Leitura do post publicado.">
  <article class="post-content">
    {post ? (
      <>
        <header class="post-header">
          <div class="post-meta-row">
            <span class="post-type">{typeLabels[post.type] ?? post.type}</span>
            <span class="post-date">{formatDate(post.publishedAt ?? post.updatedAt)}</span>
          </div>
          <h1>{post.title}</h1>
          <p class="post-meta">Tipo: {typeLabels[post.type] ?? post.type}</p>
          {post.tags && post.tags.length > 0 && (
            <div class="tag-chips" aria-label="Tags">
              {post.tags.map((tag) => (
                <span class="tag-chip">{tag}</span>
              ))}
            </div>
          )}
        </header>
        <div class="post-body">
          <pre class="post-content-raw">{post.content ?? ''}</pre>
        </div>
      </>
    ) : (
      <p class="post-meta">Post nao encontrado.</p>
    )}

    <p class="post-back">
      <a href={homeHref}>Voltar para a home</a>
    </p>
  </article>
</BaseLayout>
